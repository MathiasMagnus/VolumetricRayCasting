#include "GraphicsScene.h"


GraphicsScene::GraphicsScene(QObject *parent) :
	QGraphicsScene(parent)
{
	m_graphicsPixmapItem = new QGraphicsPixmapItem();
	addItem(m_graphicsPixmapItem);
}

void GraphicsScene::wheelEvent(QGraphicsSceneWheelEvent *wheelEvent)
{
	int delta = wheelEvent->delta() / 120; 
	QVector3D newCameraPos = rayCastScene.GetCameraPos();
	newCameraPos.setZ(newCameraPos.z() + newCameraPos.z() / (50.0 * delta * copysignf(1.0, rayCastScene.GetCameraViewDir().z())));
	newCameraPos.setY(newCameraPos.y() + newCameraPos.y() / (50.0 * delta * copysignf(1.0, rayCastScene.GetCameraViewDir().y())));
	newCameraPos.setX(newCameraPos.x() + newCameraPos.x() / (50.0 * delta * copysignf(1.0, rayCastScene.GetCameraViewDir().x())));
	
	RaycastFromCameraPos(newCameraPos);

	//QGraphicsScene::wheelEvent(wheelEvent); // kell-e ez nekem?
}

void GraphicsScene::SetScene(const SceneData &sceneData)
{
	// Init with camera position, viewed posisiton, field of view
	rayCastScene.Init(sceneData.cameraPositionData, sceneData.viewedPosisitonData, sceneData.fieldOfViewData);
	rayCastScene.SetLimits(sceneData.extentData);
	rayCastScene.m_densityFunc = sceneData.functionData;
}

void GraphicsScene::Raycast() 
{
	//Raycast scene
	rayCastScene.Raycast();
	const std::vector<unsigned char> rgbData = rayCastScene.GetRGBData();

	const uchar* pixDataRGB = &rgbData[0];
	// 400 pixels width, 300 pixels height, x bytes per line, RGB888 format
	QImage img(pixDataRGB, 400, 300, 400 * 3, QImage::Format_RGB888); 															
	QPixmap pix = QPixmap::fromImage(img); // Create pixmap from image
	m_graphicsPixmapItem->setPixmap(pix);
}

void GraphicsScene::RaycastFromCameraPos(const QVector3D &cameraPosition)
{
	rayCastScene.SetCameraPos(cameraPosition);
	Raycast();
}

